## イントロダクション

ハリケーン、竜巻、地震、洪水などの自然災害は、毎年インフラに大きな被害を与え、人命、時間、そして何十億ドルもの損失をもたらしています。そのため、被害の規模を把握し、初動対応者を誘導するための地図を迅速に作成することが求められています。

スペースネットの過去のチャレンジのデータセットと受賞したアルゴリズムを実際の災害対応シナリオに適用することで、我々は以下の質問に答えたいと考えています。

過去のスペースネットの課題から、建物や道路の抽出はどのように改善されたのか？
多クラス特徴抽出の課題では、性能にどのような影響があるのか？
洪水前の道路と洪水後の衛星画像から、洪水によって塞がれた道路をどれだけ正確に特徴付けることができるか？

## データ

Maxarオープンデータプログラムでは、突発的に発生する大規模な危機事象の中から厳選した高解像度の衛星画像を公開しています。過去5年間、洪水に関するイベントが多数ありました。このプログラムでは、災害前と災害後の画像を公開しており、現地の状況を比較・分析することができます。Maxar Open Data Programの画像を使って、イベント前後の画像を考慮したデータアノテーションを収集しました。イベント前の画像から、アナリストはすべての建物のフットプリントと高速道路のセンターラインを収集しました。高速道路は、道路タイプ（住宅地など）、路面タイプ（舗装、未舗装）、車線数で分類されました。災害前のベースラインデータセットを作成した後、解析者は災害後の画像を使用して、画像上で浸水しているように見える建物や道路セグメントを特定しました。道路区間は、災害後の画像で目に見えて水や瓦礫で覆われている場合、冠水していると判断される。建物に冠水属性が付与された場合、その近辺に洪水があることを意味します（衛星画像では、実際に建物内部が冠水しているかどうかを判断することはできないため）。洪水災害ではよくあることですが、雲がかかっていて画像中の特徴が見えない場合、解析者は見えているものだけを属性として指定し、特徴が見えない場合は仮定をしないように指示されました。

## 衛星写真

画像はRGB（赤、緑、青）の画像タイルで、様々なサイズと解像度（30～70cm/pixel）で構成されています。画像は[GeoTiff](https://en.wikipedia.org/wiki/GeoTIFF)フォーマットで提供されます。ほとんどのタイルでは、イベント前とイベント後の2つの画像が提供されています。一部のタイルでは、イベント後の画像が複数あります（部分的に雲がかかっていたり、光の状態が悪かったりするため）。

## アノテーション

本書では、既知の建物や道路の位置や形状を「グランドトゥルース」と呼ぶ。位置と形状の情報は、[Well Known Text](https://en.wikipedia.org/wiki/Well-known_text_representation_of_geometry) 形式で提供される。WKT規格のPOLYGON（建物）、LINESTRING（道路）オブジェクトタイプのみ対応している。これらのデータは、以下のフォーマットで CSV ファイルに記述される。
> ImageId,Object,WKT_Pix,Flooded,length_m,travel_time_s
ファイルの各行は、以下のように建物または道路セグメントを定義する。

- ImageId:画像を一意に識別するための（大文字と小文字を区別する）文字列である。
- Object:"Building" または "Road" のいずれかである。
- WKT_Pix
  - 建物の場合、建物を表す形状の点を Well Known Text フォーマットで指定する。
  - 画像に建物がない場合、この列には POLYGON EMPTY 構造が使用される。ポリゴンは閉じていなければならないので、点リストの最初と最後の項目は同じでなければならない。
  - 道路については、Well Known Text 形式で道路網を表す点と辺を指定する。画像に道路がない場合、この列には LINESTRING EMPTY 構造が使われる。
  - 座標系は画像の左上隅を原点 と し 、 第 1 座標は x 値 （正の値は右）、 第 2 座標は y 値 （正の値は下） です。
- Flooded:"True "または "False "のどちらかである。
- length_m:WKT_Pix が LINESTRING EMPTY の場合、または Object が Building の場合は null となる。
- travel_time_s:WKT_Pix が LINESTRING EMPTY の場合、または Object が Building の場合、null を指定する。これは情報提供のためだけであり、travel_time はこの課題の採点には関係ない。


## その他ファイル

- resolutions.txt:ImageIdsは16桁の16進文字列で始まる。このような一意の文字列それぞれについて、resolution.txt は、ピクセルサイズ（単位はメートル）、それが PRE 画像か POST 画像か、そして ImageId にこの接頭語を持つ画像の幅と高さの最大値を含んでいます。タイリングの関係で、画像のサイズはこの値より（どちらか、あるいは両方の次元で）小さくなる可能性があることに注意。
- xxx_label_image_mapping.csv:各PRE画像は、対応する1つか2つのPOST画像を持っています。これらのファイルには、PRE 画像のファイル名から POST 画像のファイル名へのマッピングが含まれています。

## アノテーションサンプル

```
ImageId,Object,WKT_Pix,Flooded,length_m,travel_time_s

10500500C4DD7000_0_15_63,Building,"POLYGON ((600 500,700 500,700 600,600 600,600 500))",True,null,null

10500500C4DD7000_0_15_0,Building,POLYGON EMPTY,False,null,null

10500500C4DD7000_0_15_63,Building,"POLYGON ((750 650,850 650,850 750,750 750,750 650))",False,null,null

10500500C4DD7000_0_15_63,Road,"LINESTRING (100 100,200 100,200 200)",True,41.492,3.094

10500500C4DD7000_0_15_63,Road,"LINESTRING (661.7 1002, 670.5 1058.5)",False,96.208,7.174

10500500C4DD7000_0_15_0,Road,LINESTRING EMPTY,False,null,null
```

## データに関する注意事項

- 画像には情報のない領域が含まれることがある。これらの領域は黒く塗りつぶされた領域として表示されますが、アルゴリズムがこれを処理できる必要があります。このような、POST画像に情報がない領域には、注釈も存在しません。(つまり、少なくとも1枚のPOST画像で見える範囲に注釈が切り取られているのです)。
- WKTファイルに加えて、トレーニングセットのアノテーションは.geojsonフォーマットでも提供されています。これらのファイルには、WKTファイルよりも多くの情報が含まれていますので、ご自由にお使いください。

## ダウンロード

入力ファイルは、AWSバケットのspacenet-datasetからダウンロードすることができます。AWS S3バケットに保存されたデータにアクセスするためのアカウントを設定する方法の詳細については、このガイドを参照してください。

同じバケットには、以前のSpaceNetチャレンジのデータも保存されています。このチャレンジでは、バケットコンテンツのサブセット（spacenet/SN8_floodsディレクトリのファイル）のみが必要ですが、建物や道路データなど、以前のSpaceNetデータセットは必要に応じて追加のトレーニングに使用することが可能です。

ここでは

tarballs/Germany_Training_Public.tar.gzとtarballs/Louisiana-East_Training_Public.tar.gzにはSpaceNet 8学習データ（2AOI（関心領域）の画像、道路、建物注釈）が格納されています。(4.4 GB)
tarballs/Louisiana-West_Test_Public.tar.gz は、チャレンジの暫定テストフェーズで結果を提出するために使用されるテストセットです。画像は含まれていますが、アノテーションは含まれていません。(2.4 GB)
なお、Germany_Training_Public/, Louisiana-East_Training_Public/, Louisiana-West_Test_Public/ の各フォルダでは、個別のファイルやより小さなサブセットを入手できます。フルセットをダウンロードすることなく、データに慣れたい場合は、これらを使用してください。

## Output File

出力は、アノテーションファイルと同じフォーマットのCSVファイルである必要があります。

画像ID,オブジェクト,WKT_Pix,Flooded,length_m,travel_time_s
出力ファイルには、上記のヘッダー行を含んでも含まなくてもかまいません。残りの行は、アルゴリズムが抽出した建物と道路セグメントを、1行につき1つずつ指定する必要があります。

出力はCSVの拡張子を持つ1つのファイルでなければならない。ファイルのサイズは500MB以下、行数は400万行以下でなければならない。

制約事項および注意事項

- 1つのファイルには、テストセット内のすべての画像の建物の足跡と道路が含まれている必要があります。
- ファイルには、同じ ImageId の複数の行が含まれることがあります（通常、含まれます）。
- 出力には PRE 画像の ImageId を使用する必要があります。(PRE と POST の ID は異なります)。
- 画像に建物がない場合は、POLYGON EMPTY構文を使用しなければなりません。この場合、ファイルには同じImageIdの建物を定義する他の行が含まれていてはいけません。
- 同様に、画像から道路が見つからなかった場合は、LINESTRING EMPTY を使用しなければなりません。この場合、同じImageIdの道路を定義する他の行がファイルに含まれていてはならない。
- このコンテストでは、travel_time_s フィールドは採点に使われないので、各道路セグメントに定数値または Null を自由に指定することができます。ただし、この値は出力に含まれる必要があります。

## 提出フォーマットとコード要件

この試合では、「データ提出」と「コード提出」の2つの提出形式を組み合わせて使用します。提出パッケージの必須フォーマットは、提出テンプレート文書で指定されます。このドキュメントには、テンプレートに記載されている要件を追加またはオーバーライドする要件のみが含まれています。

- 1日に3回以上投稿することはできません。投稿プラットフォームはこの制限を強制しませんので、投稿者の責任でこの制限を遵守してください。このルールに従わない場合、失格となることがあります。
- 例外として、投稿した作品が0点だった場合、1時間経過後に新たに投稿することができます。
- 提出パッケージの /solution フォルダには、solution.csv ファイルが含まれていなければなりません。このファイルは、上記の Output file セクションで指定したフォーマットで、テストセット内のすべての画像から抽出したすべての建物と道路をリストアップしなければなりません。

## スコアリング

採点中、あなたの solution.csv ファイル (暫定テストでは提出ファイルに含まれ、最終テストではあなたの docker コンテナによって生成されます) は、次のアルゴリズムを使って予想されるグランドトゥルースデータと照合されます。

あなたのソリューションが無効な場合 (テスターツールがそのコンテンツを正常に解析できない場合など)、スコアは 0 になります。

提出されたソリューションが有効な場合、建物についてはIOUベースのメトリックを使用し、道路についてはAPLSアルゴリズムを使用してスコアリングされます。アルゴリズムの主なステップを以下に説明するが、ここには書かれていない細かい部分がたくさんある。決定的で詳細なアルゴリズムについては、ビジュアライザー・ツールのソースコードを参照してください。

建物については、各タイルについて、IOU（Intersection over Union、またはJaccard index）が浸水した建物と浸水していない建物について別々に計算されます。これまでのSpacenetの課題とは異なり、ここでは建物の面積の和がこの計算に使用され、個々の建物の分離にはこだわらない。タイルレベルの建物のスコアは、これら2つのIOUスコアの平均である。(重要な特殊ケース：2つの空の領域のIOUは1（可能な限り最高のスコア）である）。

道路については、タイルレベルのスコアは、2つのAPLSスコアの平均として計算される：1つは道路網の浸水したサブセット、もう1つは道路網の浸水していないサブセットである。このとき、APLSメトリックの長さに基づくバージョンを使用する。

タイルの総合スコアは、タイルレベルの建物スコアと道路スコアの平均である。テストセットの総合スコアはタイルレベルのスコアの平均であり，0,...,100の範囲にスケールアップされたものである．

## APLS メトリック

参考のため、タイルレベルのAPLS計算のステップを以下に示すが、上に述べたように、完全な詳細はビジュアライザーとスコアラーツールのソースコードで利用可能である。

1. タイル上の道路網の浸水または非浸水サブグラフを表すグランドトゥルースグラフをTとし、それに対する予測グラフをPとする。これらのグラフは、LineStringに存在する各点をグラフのノードとして扱い、各線分（LineStringの連続した点のペア）を2つのノード間のエッジとして扱うことによって、LineStringベースの表現から作成される。これらのグラフは、a) ノードは物理的な位置を表し、b) エッジはノード間の接続の存在以上のもの、つまり形状（直線セグメントの連続）を持つため、数学で用いられるグラフ概念とは異なることに注意されたい。
1. 両方のグラフが空の場合（エッジを含まない場合）、スコアは1（タイルレベルの最高のスコア）です。もし片方のグラフだけが空であれば、スコアは0である（最悪のタイルレベル・スコア）。そうでなければ、以下のすべてのステップが実行される。
1. 両グラフは簡略化され、平滑化される。
   1. 簡略化とは、2つの隣接を持つノードを削除することである。ノード B がノード A と C にのみ接続されている場合，B は除去され，A と C の間の新しいエッジが，A と C の間のルートの形状がこのステップの前と同じになるように作成される．このステップをすべての2連結ノードについて繰り返した後、道路の分岐点と道路の終点だけがノードとして残り、ネットワークの元の形状（線分の集合）は変更されないままである。(特殊なケースとして、サイクル: 2-連結ノードのみを含み、他の連結を持たない部分グラフがある。ここでは、2つのノードが接続されていても、すべてのノードを維持する)。
   1. スムージングとは、グラフに余分なノードを挿入して、50メートル以上のエッジがないようにすることである。例えば、A-B間のエッジの長さが120mで（これはユークリッド距離ではなく、2つの端点間の経路に沿って測定される、最も極端なケースではAとBは同じかもしれない）、50m以上のエッジを許さない場合、ノードAから40mと80mのところに2つのノードが追加挿入される。
1. 2つのグラフG1、G2間のAPLSスコアは以下のように計算される。
    1. グラフG2の複製を作成し、これをG2'と呼ぶ。G1のすべてのノードをG2'に注入する。つまり、G1のノードnに対して、G2'の中で最も近い点を探し、そこにノードn'を作る。(このようなn'はG2'の既存のノードに対応するものではなく、エッジ上に作成される可能性があることに注意)。nとn'のユークリッド距離は4m以下でなければならず、そうでない場合はこの与えられたnに対してn'は注入されない。
    1. G1内の有効な経路(p1→p2)をすべてリストアップし、G2'内の対応する経路(p1'→p2')がどうなるかをチェックして、経路差のスコアを集計する。p1からp2への経路は、G1においてその間に経路が存在すれば有効である。(経路は、2つのノード間の直接接続でも、p1から始まってp2で終わるより長いエッジの列でもよい)。
        1. G2'に一致するp1'がない場合、G1に存在するp1から始まる全ての有効な経路について、差分スコアを1加算する。
        1. マッチするp1'があるがマッチするp2'がない場合にも、差分スコア1を追加する。
        1. マッチするp1'とp2'があるが、G2'にそれらの間のルートがない場合、差分スコア1も追加される。
        1. 一致するp1'とp2'があり、それらがG2'で接続されている場合、以下のように計算された差分スコアを追加する。
        > min(1, abs(len - len') / len)

        ここで、len と len' はそれぞれ G1 と G2' における2点を結ぶパスの長さである。(このステップはSpacenet 5で用いられたものとは異なることに注意。以前はこのステップでは、経路長の代わりに移動時間が使われていた)。
    1. 差分スコアの合計をG1の有効経路数(p1→p2)で割ったものをavgDiffとする。
    1. G1 と G2 の間の APLS スコアは 1 - avgDiff である．
1. T と P の間の APLS スコアを計算する。
1. APLS スコアの計算を P から T への反対方向にも繰り返す．
1. タイルレベルのスコアは、前の2つのステップで計算された2つのスコアの調和平均とされる。

## 最終評価

このセクションでは、最終テストのワークフローを詳細に説明し、提出物の /code フォルダに対する要件は、提出物のテンプレート文書でも指定されています。このドキュメントには、テンプレートに記載されている要件を追加または上書きする要件や情報のみが記載されています。最終テストのためにシステムを準備するまでは、このセクションを無視してもかまいません。

- 列車スクリプトの署名はテンプレートにある通りです。

    > train.sh {data_folder} 

    data_folder}パラメータは、SpaceNet衛星データおよびアノテーションを格納するフォルダを指します。提供された{data_folder}は、AOIを表すtrainingフォルダの親フォルダとなります。
- train.shスクリプトの制限時間は8GPU-daysです（4GPUのp3.8xlargeでは2日）。この制限時間を超えるスクリプトは切り捨てられます。
- トレーニングスクリプトの呼び出し例は以下の通りです。フォルダ名はあくまで例であり、テスト時に全く同じフォルダ名が使用されるとは思わないでください。

> ./train.sh /data/SN8_flood/train/

    このサンプルの場合、学習データは以下のようになります。
```
  data/
    SN8_flood/
      train/
        Germany_Training_Public/
          POST-event/
          PRE-event/
          annotations/
          Germany_Training_Public_label_image_mapping.csv
          Germany_Training_Public_reference.csv
        Louisiana-East_Training_Public/
          POST-event/
          ... etc., other folders and files for this AOI
        resolutions.txt
```

- テストスクリプトの署名

> test.sh {data_folder} {output_file} 

    テストデータフォルダには、コーディングの段階で利用可能なものと同様のイメージが含まれています。

- test.sh スクリプトの制限時間は、完全な暫定テストセット（コンテストで提出したものと同じ）で実行した場合、12 GPU 時間（4 GPU の p3.8xlarge で 3 時間）です。この制限時間を超えるスクリプトは切り捨てられます。
- テストスクリプトの呼び出し例は次のとおりです。繰り返しになりますが、フォルダ名とファイル名はあくまで例であり、テスト時にまったく同じ名前が使用されるとは思わないでください。

> ./test.sh /data/SN8_flood/test/ /wdata/
my_output.csv

このサンプルの場合、テスト用データは以下のようになります。

```フォルダ構成
data/
    SN8_flood/
      test/
        Louisiana-West_Test_Public/
          POST-event/
          PRE-event/
          Louisiana-West_Test_Public_label_image_mapping.csv
        resolutions.txt

```

- 最終的なテストプロセスをスピードアップするために、コンテスト管理者は、各出場者の提出物のドッカー化されたバージョンをビルドして実行しないことを決定することができます。しかし、少なくとも上位10位までの応募作品（応募段階終了時の暫定的なリーダーボードに基づく）は、最終テストを行うことが保証されています。
- ハードウェアの仕様 あなたのDockerイメージは、p3.8xlarge Linux AWSインスタンス上でビルド、test.shおよびtrain.shスクリプトが実行されます。このインスタンスタイプの詳細については、[こちら](https://aws.amazon.com/jp/ec2/instance-types/)をご覧ください。

## 追加リソース

- [ビジュアライザー](https://drive.google.com/file/d/1hjSyZjorfLLfYVpti42Rbm5H1rCUkbPz/view)は、あなたのソリューションをローカルでテストするために利用できます。衛星画像、抽出された建物のフットプリント、予想されるグランドトゥルースを表示します。また、詳細なスコアを計算するため、オフラインのテスターとしても利用できます。
- Pythonによる[ベースライン](https://github.com/SpaceNetChallenge/SpaceNet8)実装が利用可能です。
APLS githubリポジトリには、APLSアルゴリズムのPython実装が含まれています。
- 過去のスペースネットのコンテストで入賞した作品のアルゴリズム説明とソースコードは[こちら](https://github.com/CosmiQ/apls)です。あなたの作品に合うように自由に使ってください。

## 一般注意事

- この試合はノン・レーティングです。
- チーム編成は可能です。本大会では、Topcoderのメンバーはチームを結成することができます。チーム結成後は、同じチームに所属するTopcoder同士で協力することができます。チームを結成するためには、Topcoderメンバーは他のTopcoderメンバーを募集し、このTopcoderチーム編成フォームに記入してチームを登録することができます。各チームは、キャプテンを宣言する必要があります。チームのすべての参加者は、Topcoderの優良会員として登録されていなければなりません。チームのすべての参加者は、チームに参加する前に、個別に本コンペティションに登録し、その利用規約に同意する必要があります。チームキャプテンは、チームフォームに各チームメイトの賞品分配率を割り当てる必要があります。すべての賞金配分比率の合計は100％でなければならない。チームの最小許容人数は1人、最大許容人数は5人です。チームキャプテンのみが、本コンペティションに解答を提出することができます。チームに参加している Topcoder のメンバーは、本コンペティションのレーティングを受けることができません。Topcoder の規則および条件にかかわらず、この課題のチームのメンバーでありながら、チームのキャプテンではない Topcoder のメンバーが提出したソリューションは、許可されず、賞の対象とはならず、削除される場合があり、チーム全体の課題からの解任の根拠となる場合があります。チーム結成の期限は、チャレンジ詳細ページに示された登録・提出開始日から21日目の午後11時59分（米国東部標準時）です。Topcoder は、Topcoder チーム編成フォームを完了した各チームに対してチーム編成契約を作成し、チームの各メンバーに配布します。チーム契約は、各チームメンバーによって電子的に署名されなければ有効とはみなされません。登録と提出が開始された日から28日目の午後11時59分（東部標準時）までに、すべてのチームメンバーによって電子的に署名されない限り、すべてのチーム合意は無効となります（チャレンジ詳細ページに表示）。この期間以降に受け取ったチーム契約は無効となります。チーム規約は、署名後にいかなる形でも変更することはできません。登録されたチームは、コンテストフォーラムの「登録チーム」というタイトルのスレッドに掲載される。
- 企業などの組織は、チームとして登録され、Topcoderのすべてのルールに従えば、1人の競技者として出場することができます。
- 放棄する Topcoderは、登録された競技者またはチームが「放棄」することを許可しています。放棄すると、そのメンバーは競技に参加し、私たちはそのソリューションを採点しますが、賞金を得ることはできません。放棄された方、またはチームは、フォーラムの「放棄された競技者」と書かれたスレッドに名前を掲載します。放棄した人は、リーダーボードの地位を維持するために、実装コードとメソッドを提出する必要があります。
- この試合では、Topcoderが無償で実行できるのであれば、商用ソリューションを含むあらゆるプログラミング言語とライブラリを使用することができます。また、オープンソースの言語やライブラリを使用することもできますが、次のセクションに記載されている制限事項があります。ソリューションにライセンスが必要な場合は、これらのライセンスを所有し、テスト用VMに合法的にインストールできる必要があります (「賞品を獲得するための要件」のセクションを参照)。投稿は確認後、削除/破棄されます。Topcoderは、あなたのコードを実行するためのライセンスを購入することはありません。応募の前に、応募作品がTopcoderで無償で実行できること、および必要なすべてのライセンスが応募作品のソリューションにプリインストールされていることを、絶対に確認してください。コードが実行されない場合、Topcoder は投稿者に連絡して追加の指示を求める必要はありません。ライセンスの問題 (ライセンスのダウンロードが必要な場合も含む) により、お客様のソリューションが実行できない場合、応募が拒否されることがあります。この要件について懸念がある場合は、必ずすぐにご連絡ください。
- オープンソースの言語とライブラリは、あなたの使用、他の競合他社の使用、またはクライアントによる使用に対して等しく自由である場合に限り、使用することができます。
- ソリューションにライセンスされたソフトウェア（商用ソフトウェア、オープンソースソフトウェアなど）が含まれる場合、提出書類にライセンス契約書の全文を添付する必要があります。ライセンスは、「Licenses」とラベル付けされたフォルダーに含めてください。同じフォルダ内に「README」とラベル付けされたテキストファイルがあり、ソリューションで使用される各ライセンス ソフトウェア パッケージの目的が説明されています。
  - 外部データセットおよび事前学習済みネットワークは、以下を満たす場合に限り、競技会で使用することができる。
  - 外部データおよび事前学習済みネットワークのデータセットが、コンペティションでの使用に抵触する法的制約を受けていないこと。
  - 事前学習済みネットワークを学習させるために使用するデータソースまたはデータが、応募作品の説明文に定義されていること。
  - 外部データソースは、コンペティションの最初の30日間にコンペティション・フォーラムで宣言されなければ、最終解答の対象にはなりません。参考文献や入手方法の説明は、有効な宣言となります（ライセンス制限のある場合など）。特定の外部データソースを使用したい場合は、「リクエストされたデータソース」というタイトルのフォーラムスレッドに質問を投稿してください。コンテストの関係者がその要求を確認し、データソースの使用が承認されれば、「承認されたデータソース」というタイトルのフォーラムスレッドに掲載されます。
  - OpenStreetMapまたは類似の、対象となるテスト都市を明示的に記述した街路レベルのデータソースの使用は許可されません。
  - テスト段階では、データのジオリファレンス（地理的な座標を利用すること）を使用することは許可されません。
  - 予測スコアを向上させるために、地理的に隣接するタイルを使用することは許可されません。
  - 一般的な質問や問題の報告にはマッチフォーラムを使用してください。ただし、考えられる解決手法に関する情報を明らかにするようなコメントや質問の投稿はご遠慮ください。